import numpy as np
import pandas as pd
import datetime as dt
from Chan.data_structure import *
from Chan.indicator import *
from quantax.data_query_advance import local_get_stock_day_adv, local_get_stock_min_adv

beiji = ['000008','000012','000016','000021','000027','000046','000059','000061','000062','000069','000078','000096','000156','000158','000166','000301','000402','000415','000426','000516','000540','000543','000550','000559','000560','000563','000582','000591','000598','000601','000623','000629','000630','000657','000667','000672','000685','000688','000709','000717','000718','000719','000723','000758','000818','000825','000826','000830','000831','000839','000869','000881','000883','000887','000898','000903','000933','000937','000958','000959','000960','000963','000983','000987','000990','001696','001965','001979','002002','002004','002010','002024','002030','002036','002038','002075','002091','002099','002118','002130','002145','002151','002152','002183','002191','002195','002204','002217','002239','002249','002252','002276','002294','002310','002318','002372','002390','002408','002416','002423','002424','002428','002429','002458','002468','002481','002484','002489','002505','002506','002603','002611','002617','002626','002635','002641','002673','002699','002701','002733','002737','002807','002839','002936','002958','002966','300002','300072','300085','300131','300257','300339','300346','300390','300429','300634','600000','600007','600010','600011','600012','600015','600016','600018','600019','600025','600028','600050','600053','600056','600062','600073','600104','600105','600111','600115','600136','600141','600150','600160','600177','600180','600188','600206','600208','600210','600219','600233','600236','600260','600261','600273','600295','600299','600326','600329','600332','600338','600340','600348','600352','600362','600363','600366','600369','600373','600377','600388','600392','600398','600409','600422','600446','600459','600489','600500','600511','600516','600531','600549','600566','600567','600572','600580','600598','600606','600621','600637','600639','600641','600642','600643','600648','600655','600657','600663','600674','600682','600704','600705','600711','600728','600737','600742','600748','600755','600756','600777','600787','600803','600823','600827','600848','600895','600900','600903','600909','600918','600928','600996','601000','601001','601005','601016','601018','601077','601088','601111','601139','601155','601169','601198','601216','601229','601238','601288','601311','601328','601333','601360','601398','601519','601567','601598','601600','601628','601633','601666','601678','601696','601699','601727','601800','601808','601818','601828','601857','601860','601866','601877','601878','601880','601881','601898','601919','601952','601958','601985','601988','601992','601998','603043','603068','603128','603198','603225','603260','603279','603288','603298','603466','603505','603556','603568','603638','603728','603858','603868','603877','603927','000001','000002','000004','000009','000011','000026','000028','000030','000031','000034','000036','000039','000049','000050','000060','000063','000066','000088','000089','000090','000100','000157','000333','000338','000400','000401','000403','000423','000425','000430','000488','000501','000507','000513','000520','000526','000528','000537','000538','000546','000547','000552','000553','000561','000568','000570','000581','000589','000596','000600','000603','000610','000625','000627','000636','000639','000651','000656','000661','000671','000681','000683','000686','000690','000697','000698','000703','000708','000710','000712','000725','000728','000729','000733','000738','000739','000750','000757','000761','000767','000768','000776','000778','000783','000786','000789','000793','000796','000799','000800','000807','000813','000836','000848','000858','000860','000863','000876','000877','000878','000888','000895','000897','000900','000901','000902','000910','000913','000915','000921','000922','000923','000925','000930','000932','000936','000938','000950','000951','000961','000967','000970','000975','000976','000977','000988','000997','000998','000999','001914','002001','002007','002008','002013','002014','002019','002020','002022','002025','002027','002028','002029','002032','002034','002035','002041','002042','002043','002044','002046','002048','002049','002050','002056','002058','002063','002064','002065','002068','002073','002078','002080','002081','002084','002088','002092','002094','002100','002105','002106','002110','002114','002120','002123','002124','002125','002126','002127','002128','002129','002131','002132','002135','002138','002139','002142','002146','002153','002155','002156','002157','002158','002159','002160','002168','002171','002174','002179','002180','002182','002185','002202','002203','002206','002207','002212','002213','002214','002216','002221','002223','002227','002230','002233','002236','002237','002241','002242','002244','002250','002251','002254','002258','002262','002266','002267','002269','002271','002273','002281','002285','002286','002291','002292','002298','002299','002301','002303','002304','002308','002311','002313','002314','002315','002317','002322','002324','002326','002327','002332','002338','002340','002343','002351','002352','002353','002355','002358','002362','002367','002368','002371','002373','002375','002380','002381','002382','002384','002385','002387','002389','002392','002396','002397','002398','002399','002402','002404','002405','002407','002409','002410','002413','002414','002415','002419','002422','002425','002430','002434','002436','002438','002439','002440','002441','002444','002446','002449','002452','002455','002456','002459','002460','002461','002463','002465','002474','002475','002488','002493','002497','002500','002507','002508','002511','002520','002524','002531','002541','002544','002555','002557','002558','002563','002564','002567','002568','002572','002583','002585','002589','002594','002595','002597','002600','002601','002602','002605','002607','002609','002612','002614','002616','002623','002624','002625','002627','002632','002643','002645','002646','002648','002651','002653','002655','002661','002664','002665','002668','002672','002675','002676','002677','002683','002685','002688','002690','002695','002696','002697','002698','002702','002705','002706','002707','002709','002712','002713','002714','002726','002727','002734','002736','002739','002743','002745','002747','002749','002756','002758','002768','002772','002773','002776','002777','002780','002781','002787','002791','002793','002796','002797','002798','002803','002810','002812','002815','002818','002821','002829','002831','002832','002833','002835','002837','002841','002845','002847','002850','002851','002853','002857','002858','002859','002866','002867','002869','002876','002878','002884','002887','002891','002897','002901','002902','002905','002906','002909','002912','002916','002918','002920','002925','002926','002928','002930','002933','002935','002938','002939','002940','002941','002942','002943','002946','002947','002949','002956','002959','002960','002961','002965','002967','002968','002970','002971','002972','002973','002977','002979','002982','002985','002986','002989','002990','003816','300001','300003','300009','300010','300012','300014','300015','300016','300017','300019','300020','300024','300026','300030','300031','300032','300033','300034','300035','300036','300037','300038','300041','300044','300047','300054','300058','300059','300065','300068','300070','300073','300078','300081','300083','300087','300088','300097','300098','300101','300102','300108','300113','300114','300115','300118','300119','300120','300121','300122','300123','300124','300129','300132','300133','300136','300138','300142','300144','300146','300149','300151','300166','300168','300179','300180','300182','300184','300188','300190','300192','300196','300198','300203','300206','300207','300208','300212','300214','300215','300218','300223','300224','300226','300232','300233','300236','300242','300243','300244','300245','300246','300248','300251','300253','300258','300259','300261','300271','300273','300274','300275','300280','300284','300285','300293','300294','300295','300296','300298','300302','300307','300308','300315','300316','300319','300320','300322','300324','300326','300327','300331','300338','300340','300347','300348','300352','300357','300360','300363','300365','300369','300371','300373','300374','300376','300378','300379','300381','300383','300384','300394','300395','300403','300404','300406','300408','300413','300415','300416','300418','300424','300427','300428','300433','300437','300438','300439','300440','300441','300445','300447','300449','300450','300451','300452','300453','300454','300455','300456','300457','300458','300460','300463','300470','300474','300475','300476','300482','300484','300486','300487','300490','300494','300496','300497','300498','300499','300502','300503','300505','300506','300509','300511','300512','300516','300523','300525','300526','300529','300530','300545','300548','300551','300552','300558','300559','300562','300563','300564','300566','300567','300568','300569','300570','300572','300573','300575','300577','300580','300587','300590','300592','300593','300595','300596','300598','300600','300601','300603','300604','300607','300609','300613','300615','300616','300618','300622','300623','300624','300628','300629','300630','300633','300635','300636','300638','300639','300640','300648','300651','300655','300657','300659','300661','300662','300663','300666','300669','300671','300673','300674','300676','300677','300679','300680','300682','300684','300685','300686','300687','300690','300692','300696','300699','300702','300703','300705','300709','300715','300719','300722','300723','300724','300725','300726','300729','300731','300733','300735','300737','300738','300740','300741','300747','300750','300751','300753','300755','300758','300759','300760','300762','300763','300766','300767','300768','300769','300770','300772','300773','300775','300776','300777','300781','300782','300783','300785','300787','300788','300791','300792','300801','300802','300806','300815','300816','300818','300823','300824','300825','300827','300829','300832','300837','300839','300841','300842','300843','300845','300846','600004','600008','600009','600021','600026','600027','600029','600030','600031','600036','600037','600038','600039','600048','600057','600058','600059','600060','600061','600064','600066','600068','600075','600079','600085','600089','600094','600103','600109','600114','600116','600118','600125','600129','600131','600132','600138','600143','600153','600155','600161','600162','600167','600170','600171','600172','600176','600183','600184','600185','600195','600196','600197','600201','600211','600216','600252','600256','600258','600271','600276','600277','600282','600285','600297','600298','600305','600309','600312','600315','600316','600320','600323','600325','600330','600346','600350','600356','600372','600376','600378','600380','600383','600391','600395','600406','600415','600419','600425','600426','600428','600436','600438','600448','600449','600460','600461','600466','600478','600479','600480','600482','600483','600486','600487','600491','600493','600496','600498','600501','600507','600517','600519','600521','600522','600528','600529','600535','600536','600546','600547','600556','600557','600559','600562','600563','600565','600570','600582','600583','600584','600585','600587','600588','600593','600596','600597','600600','600612','600623','600624','600647','600658','600660','600667','600673','600675','600685','600688','600690','600694','600699','600702','600703','600715','600720','600729','600732','600733','600739','600740','600741','600745','600754','600760','600761','600763','600764','600765','600771','600779','600780','600782','600785','600795','600801','600805','600808','600809','600811','600812','600820','600835','600837','600839','600845','600851','600858','600859','600862','600863','600867','600869','600872','600875','600879','600881','600884','600885','600886','600887','600893','600897','600919','600926','600933','600956','600958','600966','600967','600968','600970','600971','600976','600977','600984','600985','600987','600988','600989','600990','600993','600998','600999','601003','601006','601009','601012','601015','601019','601021','601038','601058','601066','601068','601069','601098','601099','601100','601108','601116','601117','601127','601128','601137','601138','601162','601166','601179','601186','601200','601211','601222','601225','601231','601233','601236','601318','601319','601336','601375','601377','601390','601555','601566','601577','601595','601601','601606','601607','601615','601618','601636','601658','601668','601669','601677','601688','601689','601698','601717','601766','601788','601799','601816','601827','601838','601865','601869','601872','601888','601899','601901','601916','601933','601939','601965','601966','601968','601989','601990','601996','601997','603001','603003','603005','603008','603010','603011','603018','603019','603025','603026','603027','603030','603035','603039','603050','603056','603058','603060','603076','603077','603083','603086','603087','603093','603096','603103','603108','603113','603127','603129','603136','603158','603160','603161','603167','603179','603181','603185','603186','603187','603195','603197','603200','603208','603212','603214','603218','603223','603228','603229','603232','603233','603236','603238','603239','603256','603258','603259','603267','603283','603290','603297','603301','603305','603308','603313','603315','603317','603319','603327','603328','603330','603332','603336','603337','603338','603345','603348','603351','603353','603359','603363','603365','603368','603369','603377','603378','603385','603386','603387','603392','603396','603399','603416','603429','603444','603456','603486','603489','603496','603501','603506','603507','603515','603516','603517','603520','603533','603535','603536','603538','603558','603566','603579','603583','603587','603588','603589','603596','603599','603600','603601','603605','603606','603609','603610','603611','603612','603613','603626','603639','603650','603655','603657','603658','603659','603661','603666','603678','603679','603680','603686','603688','603690','603697','603699','603700','603707','603708','603711','603712','603713','603719','603721','603722','603730','603733','603737','603755','603757','603766','603786','603788','603799','603801','603806','603808','603809','603811','603813','603816','603825','603826','603833','603839','603855','603856','603859','603866','603867','603871','603881','603882','603883','603885','603887','603890','603893','603896','603898','603899','603901','603906','603909','603915','603916','603920','603938','603939','603949','603955','603956','603960','603976','603983','603985','603986','603987','603989','603990','603993','603995','605168','605288','688002','688004','688005','688006','688008','688011','688012','688015','688016','688018','688019','688020','688021','688023','688025','688026','688029','688030','688036','688037','688039','688051','688058','688066','688080','688081','688085','688086','688088','688089','688090','688096','688099','688100','688106','688108','688111','688116','688122','688126','688139','688157','688158','688159','688166','688169','688177','688178','688181','688186','688188','688189','688196','688198','688200','688202','688208','688222','688228','688233','688258','688266','688268','688277','688278','688288','688298','688299','688300','688312','688318','688333','688357','688358','688360','688363','688365','688366','688368','688369','688388','688389','688396','688398','688466','688505','688516','688518','688520','688528','688555','688558','688566','688588','688598','688599']

def extract_data_1d(code_list, start_date, end_date):
    candles = local_get_stock_day_adv(code_list, start=start_date, end=end_date).to_qfq()
    charts = []
    try:
        candles.data['ds'] = [x.strftime('%Y-%m-%d') for x in candles.data.reset_index().date.tolist()]
    except:
        candles.data['ds'] = [x.strftime('%Y-%m-%d') for x in candles.data.date.tolist()]
    for idx, candle in enumerate(candles.splits()):
        try:
            code = candle.data.head(1).reset_index().code.values[0]
        except:
            code = code_list[idx]
        chart = ChartFrame(code, 'day')
        chart.init_candles(candle.data.loc[:, ['open', 'close', 'high', 'low']].values, candle.data.ds.tolist())
        charts.append(chart)
    return candles, charts


def extract_data_min(code_list, start_date, end_date, min_level):
    candles = local_get_stock_min_adv(code_list, start=start_date, end=end_date, frequence=min_level).to_qfq()
    charts = []
    try:
        candles.data['ds'] = [x.strftime('%Y-%m-%d %H:%M:%S') for x in candles.data.reset_index().datetime.tolist()]
    except:
        candles.data['ds'] = [x.strftime('%Y-%m-%d %H:%M:%S') for x in candles.data.datetime.tolist()]
    for idx, candle in enumerate(candles.splits()):
        try:
            code = candle.data.head(1).reset_index().code.values[0]
        except:
            code = code_list[idx]
        chart = ChartFrame(code, min_level)
        chart.init_candles(candle.data.loc[:, ['open', 'close', 'high', 'low']].values, candle.data.ds.tolist())
        charts.append(chart)
    return candles, charts


if __name__ == '__main__':
    end_date = dt.datetime.today()
    # end_date = dt.datetime(2020, 10, 23)
    start_date = end_date - dt.timedelta(days=365)

    stocks = beiji
    # stocks = ['000528', '002049', '300529', '300607', '600518', '600588', '603877']
    # stocks = ['002130', '002288', '603321', '603358']
    # stocks = ['002621']

    candles, charts = extract_data_1d(stocks, start_date.strftime('%Y-%m-%d'), end_date.strftime('%Y-%m-%d'))

    indicator = ChanIndicator()
    near_lines = [(chart.code, indicator.near_pivot_lines(chart)) for chart in charts]
    chosen = [(code, line) for code, line in near_lines if line > 0]
    print(chosen)




